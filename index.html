<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Di Tub SUPREME FIX</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --text: #fff; --red: #ff0000; --blue: #3ea6ff; --gray: #aaa; }
        body.blue { --bg: #001a33; --card: #002b4d; --text: #7fdbff; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: 0.3s; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; position: sticky; top:0; background: var(--bg); z-index: 1000; border-bottom: 1px solid #333; }
        .tabs { display: flex; gap: 15px; padding: 15px 20px; background: var(--bg); position: sticky; top: 60px; z-index: 900; }
        .tab { padding: 8px 16px; border-radius: 20px; background: #333; cursor: pointer; font-size: 14px; font-weight: bold; border: none; color: white; }
        .tab.active { background: var(--text); color: var(--bg); }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; padding: 20px; }
        .shorts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }

        .card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .card video { width: 100%; aspect-ratio: 16/9; background: #000; }

        .short-card { position: relative; aspect-ratio: 9/16; border-radius: 15px; overflow: hidden; background: #000; border: 1px solid #444; }
        .short-card video { width: 100%; height: 100%; object-fit: cover; }
        
        .btn { background: var(--red); color: white; border: none; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .hidden { display: none !important; }
        input { background: #121212; color: white; border: 1px solid #333; padding: 10px; border-radius: 20px; outline: none; }
    </style>
    <script src="auth.js"></script>
    <script src="actions.js"></script>
    <script src="search.js"></script>
</head>
<body>

<div class="header">
    <a href="/" style="color:red; font-size:22px; font-weight:bold; text-decoration:none">‚ñ∂ Di Tub</a>
    <div style="width:40%">
        <!-- –í–µ—Ä–Ω—É–ª ID –¥–ª—è –ø–æ–∏—Å–∫–∞ -->
        <input type="text" id="di_phantom_search" oninput="searchVideos()" placeholder="–ü–æ–∏—Å–∫..." autocomplete="off" style="width:100%">
    </div>
    <div id="userArea"><button onclick="document.getElementById('authWin').classList.remove('hidden')" class="btn">–í—Ö–æ–¥</button></div>
</div>

<div class="tabs">
    <button class="tab active" id="btn-vids" onclick="switchTab('video')">–í–∏–¥–µ–æ</button>
    <button class="tab" id="btn-shorts" onclick="switchTab('shorts')">Shorts ‚ö°</button>
    <button class="tab" onclick="document.getElementById('uploadWin').classList.toggle('hidden')">–°–æ–∑–¥–∞—Ç—å +</button>
    <div id="settingsArea" class="hidden" style="display:flex; gap:5px; margin-left:auto">
        <button onclick="applyTheme('blue')" class="tab">Blue</button>
        <button onclick="logout()" class="btn">–í—ã—Ö–æ–¥</button>
    </div>
</div>

<div id="uploadWin" class="hidden" style="padding:20px; background:var(--card); margin:10px 20px; border-radius:15px; border:1px dashed var(--red)">
    <form action="/upload-video" method="POST" enctype="multipart/form-data">
        <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <select name="isShorts" class="tab">
            <option value="false">–í–∏–¥–µ–æ</option>
            <option value="true">Shorts</option>
        </select>
        <input type="hidden" name="author" id="authorInp">
        <input type="file" name="video" required>
        <button type="submit" class="btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
    </form>
</div>

<div id="grid" class="video-grid"></div>

<div id="authWin" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; align-items:center; justify-content:center">
    <div style="background:#111; padding:30px; border-radius:20px; text-align:center">
        <h3>Di Tub</h3>
        <input type="text" id="log" placeholder="–õ–æ–≥–∏–Ω"><br><br>
        <input type="password" id="pas" placeholder="–ü–∞—Ä–æ–ª—å"><br><br>
        <button onclick="auth('register')" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="auth('login')" class="btn" style="background:#333">–í–æ–π—Ç–∏</button>
    </div>
</div>

<script>
    let currentTab = 'video';

    function switchTab(type) {
        currentTab = type;
        document.getElementById('btn-vids').classList.toggle('active', type === 'video');
        document.getElementById('btn-shorts').classList.toggle('active', type === 'shorts');
        document.getElementById('grid').className = type === 'video' ? 'video-grid' : 'shorts-grid';
        loadVideos();
    }

    async function loadVideos() {
        const res = await fetch('/list-videos');
        const vids = await res.json();
        renderVids(vids.filter(v => (v.type || 'video') === currentTab));
    }

    function renderVids(vids) {
        const user = JSON.parse(localStorage.getItem('diUser') || '{}');
        const grid = document.getElementById('grid');
        
        grid.innerHTML = vids.reverse().map(v => {
            if (currentTab === 'video') {
                return `
                <div class="card">
                    <video controls src="/videos/${v.url}" onplay="registerView('${v.id}')"></video>
                    <div style="padding:12px">
                        <div style="display:flex; justify-content:space-between">
                            <b class="v-title">${v.title}</b>
                            ${user.login === v.author ? `<span onclick="deleteVideo('${v.id}','${v.author}')" style="cursor:pointer">üóëÔ∏è</span>` : ''}
                        </div>
                        <p style="font-size:12px; color:gray">üë§ ${v.author} ‚Ä¢ <span onclick="likeVideo('${v.id}')" style="color:red; cursor:pointer">‚ù§Ô∏è ${v.likes}</span></p>
                        
                        <!-- –í–µ—Ä–Ω—É–ª –∫–æ–º–º–µ–Ω—Ç—ã -->
                        <div class="comments">
                            <form action="/comment/${v.id}" method="POST" style="display:flex; gap:5px">
                                <input type="hidden" name="user" value="${user.login || '–ì–æ—Å—Ç—å'}">
                                <input type="text" name="text" placeholder="–ö–æ–º–º–µ–Ω—Ç..." required style="flex:1; font-size:11px">
                                <button type="submit" class="btn">‚û§</button>
                            </form>
                            ${(v.comments || []).slice(-2).map(c => `<div style="font-size:11px; margin-top:5px"><b>${c.user}:</b> ${c.text}</div>`).join('')}
                        </div>
                    </div>
                </div>`;
            } else {
                return `
                <div class="short-card">
                    <video loop src="/videos/${v.url}" onclick="this.play()" onplay="registerView('${v.id}')"></video>
                    <div style="position:absolute; bottom:10px; left:10px; color:white; text-shadow:1px 1px 5px black">
                        <b class="v-title">${v.title}</b><br>
                        <span onclick="likeVideo('${v.id}')" style="cursor:pointer">‚ù§Ô∏è ${v.likes}</span>
                    </div>
                </div>`;
            }
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', loadVideos);
</script>
</body>
</html>
